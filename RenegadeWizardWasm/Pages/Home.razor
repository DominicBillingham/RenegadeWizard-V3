@page "/"
@inject IJSRuntime JS

@using RenegadeWizardWasm.Core
@inject Terminal _terminal;
@inject MML _mml;


<PageTitle>Home</PageTitle>
<div class="d-flex flex-wrap justify-content-center gap-1">

    <!-- Left Wing - Items -->
    <div class="d-flex flex-column gap-2 justify-content-center p-2 mb-5 rounded-3"
         style="width: 200px; background: rgba(91,93,103,0.4); height: calc(100vh - 230px); margin-top: 110px;">
        @foreach (var item in LastResponse.Objects)
        {
            <div class="card shadow border-0">
                <div class="card-header fw-bold">@item.Name | @item.Hitpoints hp</div>
                <div class="card-body p-2">
                    <small>@item.Description</small>
                </div>
            </div>
        }
    </div>

    <!-- Main Terminal -->
    <div class="card shadow border-0 mt-4 "
         style="width:950px; max-width: 950px; flex: 1 1 auto; ">
        <h1 class="card-header mobile-hide">RENEGADE WIZARD</h1>
        <div class="card-body">
            <div class="form-control bg-body mb-3 text-white pb-5 position-relative mobile-max-height mobile-text-size"
                 disabled id="mainDisplay"
                 style=" overflow-y: auto; white-space: pre-wrap; font-size: 18px; height: calc(100vh - 230px); ">

@*                 <pre class="text-center m-auto ascii-art mobile-hide" style="font-size: 14px"> *@
@* *@
@*                                                                                         /\         *          *@
@* [][]    [][][]  []  []  [][][]  [][][]    []    [][]    [][][]                        //  \\               *  *@
@* []  []  []      [][ []  []      []       [][]   []  []  []                          ///    \\ =====    *      *@
@* [][]    [][][]  [] ][]  [][][]  []  []  []  []  []  []  [][][]                     //       \\     ==         *@
@* []  []  []      []  []  []      []  []  []  []  []  []  []                        //  /\  /\/\\     ==  *   * *@
@* []  []  [][][]  []  []  [][][]  [][][]  []  []  [][]    [][][]                    |/\/  \/    \\     =        *@
@*                                                                                  //        .  \\    ==  *     *@
@*                                                                                 //    .         \ ==       *  *@
@*                       W  W  W  WWWWW   WWWW     WW    WWWW    WWWW            //         V      \\          *@
@*                       W  W  W    |         W   WWWW   W   WW  W   W          //     V         .  ||         *@
@*                       W  W  W    |     WWWW   W    W  WWWWW   W   W         ||         .          \\        *@
@*                       W  W  W    |    W       W    W  W    W  W   W        //      V        V     \\        *@
@*                        WW WW   WWWWWW  WWWW   W    W  W    W  WWWW        //    .      .            \\      *@
@*                                                                         ///                    V     \\\    *@
@*                                                                        ///  .   V        .         .  \\\   *@
@* *@
@*                 </pre> *@
                @foreach (var line in ConsoleLines)
                {
                    <div class="console-line">@((MarkupString)line)</div>
                }


            </div>
            <div class="row">
                <div class="col">
                    <form @onsubmit="HandleSubmit" class="d-flex">
                        <input class="fs-5 form-control bg-white mobile-text-size" autocomplete="off" @bind="UserInput" @bind:event="oninput"
                               @onkeydown="HandleKeyDown" @onkeydown:preventDefault="_preventTabDefault"
                               id="mainTextInput" placeholder="I wonder what to do next..."/>
                    </form>

                </div>
            </div>


        </div>
    </div>

    <!-- Right Wing - Creatures -->
    <div class="d-flex flex-column gap-2 justify-content-center p-2 mb-5 rounded-3"
         style="width: 200px; background: rgba(91,93,103,0.4); height: calc(100vh - 230px); margin-top: 110px;">
        @foreach (var creature in LastResponse.Creatures)
        {
            <div class="card shadow border-0">
                <div class="card-header fw-bold">@creature.Name | @creature.Hitpoints hp</div>
                <div class="card-body p-2">
                    <small>@creature.Description</small>
                </div>
            </div>
        }
    </div>


</div>


<div class="bg-animation">
    <div id='stars'></div>
    <div id='stars2'></div>
    <div id='stars3'></div>
    <div id='stars4'></div>
</div><!-- / STAR ANIMATION -->

@code {

    private List<string> ConsoleLines { get; set; } = new();
    private List<string> _pendingLines = new();
    private TerminalResponse LastResponse { get; set; } = new();
    
    public string UserInput { get; set; } = string.Empty;
    private bool _shouldScroll = false;
    
    private List<string> _commandHistory = new();
    private int _historyIndex = -1;
    private string _tempInput = string.Empty;
    private bool _preventTabDefault = false;
    private bool _nameEntered = false;

    protected override async Task OnInitializedAsync()
    {
        await UpdateTerminal(_terminal.BeginGame(), false);
    }
    
    public async Task HandleSubmit(EventArgs e)
    {
        if (_pendingLines.Count > 0)
        {
            bool paused = false;
            if (ConsoleLines.Any())
            {
                var lastLineIndex = ConsoleLines.Count - 1;
                ConsoleLines[lastLineIndex] = ConsoleLines[lastLineIndex].Replace("▼", "").Replace("[press enter]", "");
            }
            
            while (_pendingLines.Count > 0 && !paused)
            {
                string line = _pendingLines[0];
                _pendingLines.RemoveAt(0);
                
                string words = _mml.WordReplacement(line);
                string html = _mml.Html(words);
                ConsoleLines.Add(html);
                
                if (line.Contains("▼"))
                {
                    paused = true;
                }
            }
            
            UserInput = "";
            _shouldScroll = true;
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(UserInput))
            return;
        
        _commandHistory.Add(UserInput);
        _historyIndex = -1;
        _tempInput = string.Empty;

        if (_nameEntered)
        {
            await UpdateTerminal(_terminal.EnterInput(UserInput), true);
        }
        else
        {
            await UpdateTerminal(_terminal.EnterName(UserInput), true);
            _nameEntered = true;
        }
        
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        _preventTabDefault = e.Key == "Tab";

         if (e.Key == "Enter")
         {
             await JS.InvokeVoidAsync("playEnterSound");
         }
         else
         {
             await JS.InvokeVoidAsync("playTypingSound");
         }

        if (e.Key == "Tab")
        {
            AutoComplete();
        }
         
        if (e.Key == "ArrowUp")
        {
            if (_commandHistory.Count == 0) return;

            if (_historyIndex == -1)
            {
                _tempInput = UserInput;
            }

            if (_historyIndex < _commandHistory.Count - 1)
            {
                _historyIndex++;
                UserInput = _commandHistory[_commandHistory.Count - 1 - _historyIndex];
            }
        }
        else if (e.Key == "ArrowDown")
        {
            if (_historyIndex > 0)
            {
                _historyIndex--;
                UserInput = _commandHistory[_commandHistory.Count - 1 - _historyIndex];
            }
            else if (_historyIndex == 0)
            {
                _historyIndex = -1;
                UserInput = _tempInput;
            }
        }
    }

    public async Task UpdateTerminal(TerminalResponse response, bool shouldScroll)
    {
        List<string> lines = response.Text;
        bool paused = false;

        for (int i = 0; i < lines.Count; i++)
        {
            if (paused)
            {
                _pendingLines.Add(lines[i]);
                continue;
            }

            string line = lines[i];
            string words = _mml.WordReplacement(line);
            string html = _mml.Html(words);
            ConsoleLines.Add(html);

            if (line.Contains("▼"))
            {
                paused = true;
            }
        }

        LastResponse = response;

        UserInput = "";
        _shouldScroll = shouldScroll;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldScroll)
        {
            await JS.InvokeVoidAsync("ScrollToBottom");
            _shouldScroll = false;
        }
    }

    private async Task PlaySound(string audio, bool overrideAudio)
    {
        await JS.InvokeVoidAsync("PlaySound", audio, overrideAudio);
    }

    private void AutoComplete()
    {
        string[] parts = UserInput.ToLower().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        bool hasTrailingSpace = UserInput.EndsWith(" ");
    
        if (parts.Length == 0 || hasTrailingSpace) return;

        string lastPart = parts.Last();
        
        foreach (string name in LastResponse.ActionNames)
        { 
            if (name == lastPart)
            {
                int currentIndex = LastResponse.ActionNames.IndexOf(name);
                int nextIndex = (currentIndex + 1) % LastResponse.ActionNames.Count;
                parts[^1] = LastResponse.ActionNames[nextIndex];
                UserInput = string.Join(" ", parts);
                return;
            }

            if (name.StartsWith(lastPart))
            {
                parts[^1] = name;
                UserInput = string.Join(" ", parts);
                return;
            }
        }

        foreach (string name in LastResponse.EntityNames)
        {
            if (name == lastPart)
            {
                int currentIndex = LastResponse.EntityNames.IndexOf(name);
                int nextIndex = (currentIndex + 1) % LastResponse.EntityNames.Count;
                parts[^1] = LastResponse.EntityNames[nextIndex];
                UserInput = string.Join(" ", parts);
                return;
            }

            if (name.StartsWith(lastPart))
            {
                parts[^1] = name;
                UserInput = string.Join(" ", parts);
                return;
            }
        }
    }

}

<script src="/javascript/terminal.js"></script>

<style>

    .ascii-art {
        animation: fade 15s ease forwards;
    }

    .console-line {
        animation: fade 3s ease forwards;
    }
    
    @@keyframes fade {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }
    
</style>